generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model removed. Team is now the primary identity.

model RefreshToken {
  id         String    @id @default(uuid()) @db.Uuid
  token      String    @unique
  teamId     String?   @map("team_id") @db.Uuid
  expiresAt  DateTime  @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  ipAddress  String?   @map("ip_address")
  isRevoked  Boolean   @default(false) @map("is_revoked")
  replacedBy String?   @map("replaced_by")
  revokedAt  DateTime? @map("revoked_at")
  userAgent  String?   @map("user_agent")
  team       Team?     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  sessionId    String   @unique @map("session_id")
  teamId       String?  @map("team_id") @db.Uuid
  ipAddress    String   @map("ip_address")
  userAgent    String?  @map("user_agent")
  expiresAt    DateTime @map("expires_at")
  isActive     Boolean  @default(true) @map("is_active")
  lastActivity DateTime @default(now()) @map("last_activity")
  createdAt    DateTime @default(now()) @map("created_at")
  team         Team?    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([sessionId])
  @@index([expiresAt])
  @@map("sessions")
}

model ClientGroup {
  id          String            @id @default(uuid()) @db.Uuid
  groupNo     String            @unique @map("group_no")
  groupName   String            @map("group_name")
  groupCode   String            @unique @map("group_code")
  country     String
  status      ClientGroupStatus @default(Active)
  remark      String?
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  createdBy   String?           @map("created_by") @db.Uuid
  updatedBy   String?           @map("updated_by") @db.Uuid
  companies   ClientCompany[]
  creator     Team?             @relation("CreatedByTeam", fields: [createdBy], references: [id])
  updater     Team?             @relation("UpdatedByTeam", fields: [updatedBy], references: [id])
  groups      Group[]
  ipAddresses IpAddress[]
  teams       Team[]

  @@index([groupNo])
  @@index([groupCode])
  @@index([status])
  @@index([createdAt])
  @@map("client_groups")
}

model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  teamId    String?  @map("team_id") @db.Uuid
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  oldValue  Json?    @map("old_value")
  newValue  Json?    @map("new_value")
  ipAddress String   @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  team      Team?    @relation(fields: [teamId], references: [id])

  @@index([teamId])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

model ActivityLog {
  id          String       @id @default(uuid()) @db.Uuid
  teamId      String?      @map("team_id") @db.Uuid
  type        ActivityType
  description String
  metadata    Json?
  ipAddress   String       @map("ip_address")
  createdAt   DateTime     @default(now()) @map("created_at")
  team        Team?        @relation(fields: [teamId], references: [id])

  @@index([teamId])
  @@index([type])
  @@index([createdAt])
  @@map("activity_logs")
}

model Notification {
  id          String   @id @default(uuid()) @db.Uuid
  teamId      String?  @map("team_id") @db.Uuid
  title       String
  description String
  type        String   @default("SYSTEM") // TASK, SYSTEM, etc.
  isRead      Boolean  @default(false) @map("is_read")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  team        Team?    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model FileMetadata {
  id           String    @id @default(uuid()) @db.Uuid
  fileName     String    @map("file_name")
  originalName String    @map("original_name")
  mimeType     String    @map("mime_type")
  size         Int
  url          String
  storageKey   String    @map("storage_key")
  uploadedBy   String?   @map("uploaded_by") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at")
  deletedAt    DateTime? @map("deleted_at")

  @@index([uploadedBy])
  @@index([createdAt])
  @@map("file_metadata")
}

model ClientCompany {
  id           String           @id @default(uuid()) @db.Uuid
  companyNo    String           @unique @map("company_no")
  companyName  String           @map("company_name")
  companyCode  String           @unique @map("company_code")
  groupId      String           @map("group_id") @db.Uuid
  address      String?
  status       CompanyStatus    @default(Active)
  remark       String?
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  createdBy    String?          @map("created_by") @db.Uuid
  updatedBy    String?          @map("updated_by") @db.Uuid
  creator      Team?            @relation("CompanyCreatedByTeam", fields: [createdBy], references: [id])
  group        ClientGroup      @relation(fields: [groupId], references: [id], onDelete: Restrict)
  updater      Team?            @relation("CompanyUpdatedByTeam", fields: [updatedBy], references: [id])
  locations    ClientLocation[]
  groups       Group[]
  ipAddresses  IpAddress[]
  subLocations SubLocation[]
  teams        Team[]

  @@index([companyNo])
  @@index([companyCode])
  @@index([groupId])
  @@index([status])
  @@index([createdAt])
  @@index([groupId, status, createdAt])
  @@index([status, createdAt])
  @@map("client_companies")
}

model ClientLocation {
  id           String         @id @default(uuid()) @db.Uuid
  locationNo   String         @unique @map("location_no")
  locationName String         @map("location_name")
  locationCode String         @unique @map("location_code")
  companyId    String         @map("company_id") @db.Uuid
  address      String?
  status       LocationStatus @default(Active)
  remark       String?
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  createdBy    String?        @map("created_by") @db.Uuid
  updatedBy    String?        @map("updated_by") @db.Uuid
  company      ClientCompany  @relation(fields: [companyId], references: [id], onDelete: Restrict)
  creator      Team?          @relation("LocationCreatedByTeam", fields: [createdBy], references: [id])
  updater      Team?          @relation("LocationUpdatedByTeam", fields: [updatedBy], references: [id])
  groups       Group[]
  ipAddresses  IpAddress[]
  subLocations SubLocation[]
  teams        Team[]

  @@index([locationNo])
  @@index([locationCode])
  @@index([companyId])
  @@index([status])
  @@index([createdAt])
  @@index([companyId, status, createdAt])
  @@index([status, createdAt])
  @@map("client_locations")
}

model SubLocation {
  id              String            @id @default(uuid()) @db.Uuid
  subLocationNo   String            @unique @map("sub_location_no")
  subLocationName String            @map("sub_location_name")
  subLocationCode String            @unique @map("sub_location_code")
  companyId       String            @map("company_id") @db.Uuid
  locationId      String            @map("location_id") @db.Uuid
  address         String?
  status          SubLocationStatus @default(Active)
  remark          String?
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  createdBy       String?           @map("created_by") @db.Uuid
  updatedBy       String?           @map("updated_by") @db.Uuid
  groups          Group[]
  ipAddresses     IpAddress[]
  projects        Project[]
  company         ClientCompany     @relation(fields: [companyId], references: [id], onDelete: Restrict)
  creator         Team?             @relation("SubLocationCreatedByTeam", fields: [createdBy], references: [id])
  location        ClientLocation    @relation(fields: [locationId], references: [id], onDelete: Restrict)
  updater         Team?             @relation("SubLocationUpdatedByTeam", fields: [updatedBy], references: [id])
  teams           Team[]

  @@index([subLocationNo])
  @@index([subLocationCode])
  @@index([companyId])
  @@index([locationId])
  @@index([status])
  @@index([createdAt])
  @@index([companyId, locationId, status])
  @@index([locationId, status, createdAt])
  @@index([status, createdAt])
  @@map("sub_locations")
}

model Project {
  id            String          @id @default(uuid()) @db.Uuid
  projectNo     String          @unique @map("project_no")
  projectName   String          @map("project_name")
  subLocationId String          @map("sub_location_id") @db.Uuid
  deadline      DateTime?
  priority      ProjectPriority @default(Medium)
  status        ProjectStatus   @default(Active)
  remark        String?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  createdBy     String?         @map("created_by") @db.Uuid
  updatedBy     String?         @map("updated_by") @db.Uuid
  creator       Team?           @relation("ProjectCreatedByTeam", fields: [createdBy], references: [id])
  subLocation   SubLocation     @relation(fields: [subLocationId], references: [id], onDelete: Restrict)
  updater       Team?           @relation("ProjectUpdatedByTeam", fields: [updatedBy], references: [id])
  pendingTasks  PendingTask[]
  completedTasks CompletedTask[]

  @@index([projectNo])
  @@index([subLocationId])
  @@index([status])
  @@index([priority])
  @@index([deadline])
  @@index([createdAt])
  @@index([subLocationId, status, priority])
  @@index([status, priority, deadline])
  @@index([status, createdAt])
  @@map("projects")
}

model Team {
  id                   String          @id @default(uuid()) @db.Uuid
  teamNo               String          @unique @map("team_no")
  teamName             String          @map("team_name")
  email                String          @unique
  phone                String?         @unique
  taskAssignPermission Boolean         @default(false) @map("task_assign_permission")
  clientGroupId        String?         @map("client_group_id") @db.Uuid
  companyId            String?         @map("company_id") @db.Uuid
  locationId           String?         @map("location_id") @db.Uuid
  subLocationId        String?         @map("sub_location_id") @db.Uuid
  status               TeamStatus      @default(Active)
  loginMethod          LoginMethod     @default(General)
  remark               String?
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")
  createdBy            String?         @map("created_by") @db.Uuid
  updatedBy            String?         @map("updated_by") @db.Uuid
  clientGroup          ClientGroup?    @relation(fields: [clientGroupId], references: [id], onDelete: Restrict)
  company              ClientCompany?  @relation(fields: [companyId], references: [id], onDelete: Restrict)
  creator              Team?           @relation("TeamCreatedByTeam", fields: [createdBy], references: [id])
  location             ClientLocation? @relation(fields: [locationId], references: [id], onDelete: Restrict)
  subLocation          SubLocation?    @relation(fields: [subLocationId], references: [id], onDelete: Restrict)
  updater              Team?           @relation("TeamUpdatedByTeam", fields: [updatedBy], references: [id])
  
  // Auth Fields
  password             String          @default("")
  firstName            String?         @map("first_name")
  lastName             String?         @map("last_name")
  role                 UserRole        @default(EMPLOYEE)
  isEmailVerified      Boolean         @default(false) @map("is_email_verified")
  lastLoginAt          DateTime?       @map("last_login_at")
  lastLoginIp          String?         @map("last_login_ip")
  passwordChangedAt    DateTime?       @map("password_changed_at")
  allowedIps           String[]        @default([]) @map("allowed_ips")
  deletedAt            DateTime?       @map("deleted_at")

  // Relations
  activityLogs         ActivityLog[]
  auditLogs            AuditLog[]
  refreshTokens        RefreshToken[]
  sessions             Session[]
  notifications        Notification[]
  groupMembers         GroupMember[]

  createdCompanies    ClientCompany[]  @relation("CompanyCreatedByTeam")
  updatedCompanies    ClientCompany[]  @relation("CompanyUpdatedByTeam")
  createdClientGroups ClientGroup[]    @relation("CreatedByTeam")
  updatedClientGroups ClientGroup[]    @relation("UpdatedByTeam")
  createdLocations    ClientLocation[] @relation("LocationCreatedByTeam")
  updatedLocations    ClientLocation[] @relation("LocationUpdatedByTeam")
  createdGroups       Group[]          @relation("GroupCreatedByTeam")
  updatedGroups       Group[]          @relation("GroupUpdatedByTeam")
  createdIpAddresses  IpAddress[]      @relation("IpAddressCreatedByTeam")
  updatedIpAddresses  IpAddress[]      @relation("IpAddressUpdatedByTeam")
  createdProjects     Project[]        @relation("ProjectCreatedByTeam")
  updatedProjects     Project[]        @relation("ProjectUpdatedByTeam")
  createdSubLocations SubLocation[]    @relation("SubLocationCreatedByTeam")
  updatedSubLocations SubLocation[]    @relation("SubLocationUpdatedByTeam")
  assignedPendingTasks PendingTask[]    @relation("PendingTaskAssignedToTeam")
  createdPendingTasks  PendingTask[]    @relation("PendingTaskCreatedByTeam")
  workingPendingTasks  PendingTask[]    @relation("PendingTaskWorkingByTeam")
  assignedCompletedTasks CompletedTask[] @relation("CompletedTaskAssignedToTeam")
  createdCompletedTasks  CompletedTask[] @relation("CompletedTaskCreatedByTeam")
  workingCompletedTasks  CompletedTask[] @relation("CompletedTaskWorkingByTeam")
  createdTeams        Team[]           @relation("TeamCreatedByTeam")
  updatedTeams        Team[]           @relation("TeamUpdatedByTeam")

  @@index([teamNo])
  @@index([clientGroupId])
  @@index([companyId])
  @@index([locationId])
  @@index([subLocationId])
  @@index([status])
  @@index([createdAt])
  @@index([clientGroupId, companyId, status])
  @@index([companyId, locationId, status])
  @@index([status, createdAt])
  pendingTasks         PendingTask[]   @relation("PendingTaskToTeam")
  completedTasks       CompletedTask[] @relation("CompletedTaskToTeam")
  @@map("teams")
}

model Group {
  id            String          @id @default(uuid()) @db.Uuid
  groupNo       String          @unique @map("group_no")
  groupName     String          @map("group_name")
  groupCode     String          @unique @map("group_code")
  clientGroupId String?         @map("client_group_id") @db.Uuid
  companyId     String?         @map("company_id") @db.Uuid
  locationId    String?         @map("location_id") @db.Uuid
  subLocationId String?         @map("sub_location_id") @db.Uuid
  status        GroupStatus     @default(Active)
  remark        String?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  createdBy     String?         @map("created_by") @db.Uuid
  updatedBy     String?         @map("updated_by") @db.Uuid
  clientGroup   ClientGroup?    @relation(fields: [clientGroupId], references: [id], onDelete: Restrict)
  company       ClientCompany?  @relation(fields: [companyId], references: [id], onDelete: Restrict)
  creator       Team?           @relation("GroupCreatedByTeam", fields: [createdBy], references: [id])
  location      ClientLocation? @relation(fields: [locationId], references: [id], onDelete: Restrict)
  subLocation   SubLocation?    @relation(fields: [subLocationId], references: [id], onDelete: Restrict)
  updater       Team?           @relation("GroupUpdatedByTeam", fields: [updatedBy], references: [id])
  members       GroupMember[]
  pendingTasks  PendingTask[] @relation("PendingTaskToGroup")
  completedTasks CompletedTask[] @relation("CompletedTaskToGroup")

  @@index([groupNo])
  @@index([groupCode])
  @@index([clientGroupId])
  @@index([companyId])
  @@index([locationId])
  @@index([subLocationId])
  @@index([status])
  @@index([createdAt])
  @@index([clientGroupId, companyId, status])
  @@index([companyId, locationId, status])
  @@index([status, createdAt])
  @@map("groups")
}

model GroupMember {
  id        String   @id @default(uuid()) @db.Uuid
  groupId   String   @map("group_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid // Kept as field name for DB mapping but references Team
  role      String   @default("MEMBER") // OWNER, ADMIN, MEMBER
  joinedAt  DateTime @default(now()) @map("joined_at")
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("group_members")
}

model IpAddress {
  id            String          @id @default(uuid()) @db.Uuid
  ipNo          String          @unique @map("ip_no")
  ipAddress     String          @map("ip_address")
  ipAddressName String          @map("ip_address_name")
  clientGroupId String?         @map("client_group_id") @db.Uuid
  companyId     String?         @map("company_id") @db.Uuid
  locationId    String?         @map("location_id") @db.Uuid
  subLocationId String?         @map("sub_location_id") @db.Uuid
  status        IpAddressStatus @default(Active)
  remark        String?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  createdBy     String?         @map("created_by") @db.Uuid
  updatedBy     String?         @map("updated_by") @db.Uuid
  clientGroup   ClientGroup?    @relation(fields: [clientGroupId], references: [id], onDelete: Restrict)
  company       ClientCompany?  @relation(fields: [companyId], references: [id], onDelete: Restrict)
  creator       Team?           @relation("IpAddressCreatedByTeam", fields: [createdBy], references: [id])
  location      ClientLocation? @relation(fields: [locationId], references: [id], onDelete: Restrict)
  subLocation   SubLocation?    @relation(fields: [subLocationId], references: [id], onDelete: Restrict)
  updater       Team?           @relation("IpAddressUpdatedByTeam", fields: [updatedBy], references: [id])

  @@index([ipNo])
  @@index([ipAddress])
  @@index([clientGroupId])
  @@index([companyId])
  @@index([locationId])
  @@index([subLocationId])
  @@index([status])
  @@index([createdAt])
  @@index([clientGroupId, companyId, status])
  @@index([companyId, locationId, status])
  @@index([status, createdAt])
  @@map("ip_addresses")
}

model PendingTask {
  id             String     @id @default(uuid()) @db.Uuid
  taskNo         String     @unique @map("task_no")
  taskTitle      String     @map("task_title")
  priority       String?
  taskStatus     TaskStatus @default(Pending) @map("task_status")
  additionalNote String?    @map("additional_note")
  deadline       DateTime?
  reviewedTime   DateTime[] @map("reviewed_time")
  reminderTime   DateTime[] @map("reminder_time")
  document       String?    @map("document")
  remarkChat     String?    @map("remark_chat")
  createdTime    DateTime   @default(now()) @map("created_time")
  editTime       DateTime[] @map("edit_time")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  projectId      String?    @map("project_id") @db.Uuid
  assignedTo     String?    @map("assigned_to") @db.Uuid
  targetGroupId  String?    @map("target_group_id") @db.Uuid
  targetTeamId   String?    @map("target_team_id") @db.Uuid
  createdBy      String?    @map("created_by") @db.Uuid
  workingBy      String?    @map("working_by") @db.Uuid
  assignee       Team?      @relation("PendingTaskAssignedToTeam", fields: [assignedTo], references: [id])
  creator        Team?      @relation("PendingTaskCreatedByTeam", fields: [createdBy], references: [id])
  project        Project?   @relation(fields: [projectId], references: [id])
  targetGroup    Group?     @relation("PendingTaskToGroup", fields: [targetGroupId], references: [id])
  targetTeam     Team?      @relation("PendingTaskToTeam", fields: [targetTeamId], references: [id])
  worker         Team?      @relation("PendingTaskWorkingByTeam", fields: [workingBy], references: [id])

  @@index([taskNo])
  @@index([taskStatus])
  @@index([projectId])
  @@index([assignedTo])
  @@index([targetTeamId])
  @@map("pending_tasks")
}

model CompletedTask {
  id             String    @id @default(uuid()) @db.Uuid
  taskNo         String    @unique @map("task_no")
  taskTitle      String    @map("task_title")
  priority       String?
  taskStatus     TaskStatus @default(Completed) @map("task_status")
  additionalNote String?   @map("additional_note")
  deadline       DateTime?
  completeTime   DateTime?  @map("complete_time")
  reviewedTime   DateTime[] @map("reviewed_time")
  reminderTime   DateTime[] @map("reminder_time")
  document       String?    @map("document")
  remarkChat     String?    @map("remark_chat")
  createdTime    DateTime   @default(now()) @map("created_time")
  editTime       DateTime[] @map("edit_time")
  completedAt    DateTime   @default(now()) @map("completed_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  projectId      String?   @map("project_id") @db.Uuid
  assignedTo     String?   @map("assigned_to") @db.Uuid
  targetGroupId  String?   @map("target_group_id") @db.Uuid
  targetTeamId   String?   @map("target_team_id") @db.Uuid
  createdBy      String?   @map("created_by") @db.Uuid
  workingBy      String?   @map("working_by") @db.Uuid
  assignee       Team?     @relation("CompletedTaskAssignedToTeam", fields: [assignedTo], references: [id])
  creator        Team?     @relation("CompletedTaskCreatedByTeam", fields: [createdBy], references: [id])
  project        Project?  @relation(fields: [projectId], references: [id])
  targetGroup    Group?    @relation("CompletedTaskToGroup", fields: [targetGroupId], references: [id])
  targetTeam     Team?     @relation("CompletedTaskToTeam", fields: [targetTeamId], references: [id])
  worker         Team?     @relation("CompletedTaskWorkingByTeam", fields: [workingBy], references: [id])

  @@index([taskNo])
  @@index([projectId])
  @@index([assignedTo])
  @@map("completed_tasks")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  EMPLOYEE
  HR
}

enum UserStatus {
  Active
  Inactive
  Suspended
  Pending_Verification
}

enum ClientGroupStatus {
  Active
  Inactive
}

enum ActivityType {
  LOGIN
  LOGOUT
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  BULK_OPERATION
  FILE_UPLOAD
  PASSWORD_CHANGE
  OTP_VERIFICATION
}

enum CompanyStatus {
  Active
  Inactive
}

enum LocationStatus {
  Active
  Inactive
}

enum SubLocationStatus {
  Active
  Inactive
}

enum ProjectStatus {
  Active
  Inactive
  Completed
  On_Hold
}

enum ProjectPriority {
  Low
  Medium
  High
  Critical
}

enum TeamStatus {
  Active
  Inactive
  Suspended
  Pending_Verification
}

enum LoginMethod {
  General
  Otp
  Ip_address
  Ip_Otp
}

enum GroupStatus {
  Active
  Inactive
}

enum IpAddressStatus {
  Active
  Inactive
}

enum TaskStatus {
  Pending
  ReviewPending
  Completed
}
